<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <title>Rucord</title>
    <link rel="icon" href="https://tse2.mm.bing.net/th/id/OIP.vQ7mti9LrX2yvcYNTFA_bAHaHa?rs=1&pid=ImgDetMain&o=7&rm=3">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --bg-dark: #1e1f22; --bg-panel: #2b2d31; --bg-input: #383a40; --accent: #5865f2; --green: #23a559; --red: #da373c; --text-main: #f2f3f5; --text-dim: #b5bac1; }
        
        body { margin: 0; font-family: 'Inter', sans-serif; background-color: var(--bg-dark); color: var(--text-main); display: flex; flex-direction: column; height: 100vh; overflow: hidden; background-image: url('https://cdn.discordapp.com/attachments/100000000000000000/100000000000000000/background.png'); background-size: cover; background-position: center; user-select: none; -webkit-user-select: none; }
        
        #auth-screen, #connect-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.85); backdrop-filter: blur(8px); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 20; }
        .card { background: #313338; padding: 32px; border-radius: 8px; width: 340px; box-shadow: 0 8px 24px rgba(0,0,0,0.5); text-align: center; }
        
        /* AVATAR */
        .avatar-upload { width: 100px; height: 100px; border-radius: 50%; background: var(--accent); margin: 0 auto 20px; display: flex; align-items: center; justify-content: center; cursor: pointer; position: relative; overflow: hidden; border: 4px solid var(--bg-panel); transition: 0.2s; }
        .avatar-upload:hover { opacity: 0.8; transform: scale(1.05); }
        .avatar-upload img { width: 100%; height: 100%; object-fit: cover; }
        .avatar-upload span { position: absolute; font-size: 13px; font-weight: bold; text-shadow: 0 1px 2px black; }
        
        input { width: 100%; padding: 12px; background: #1e1f22; border: none; border-radius: 4px; color: white; margin-bottom: 15px; box-sizing: border-box; outline: none; font-size: 16px; }
        .btn { width: 100%; padding: 12px; background: var(--accent); color: white; border: none; border-radius: 4px; font-weight: 600; cursor: pointer; font-size: 15px; margin-top: 5px; transition: 0.2s; }
        .btn:hover { background: #4752c4; }
        .btn-sec { background: #4e5058; } .btn-sec:hover { background: #6d6f78; }
        .link { color: #00a8fc; cursor: pointer; font-size: 14px; margin-top: 15px; display: block; }

        /* ROOM LIST STYLE */
        .room-list { display: flex; flex-direction: column; gap: 8px; margin-top: 10px; max-height: 200px; overflow-y: auto; }
        .room-btn { background: #2b2d31; padding: 12px; border-radius: 6px; text-align: left; cursor: pointer; display: flex; align-items: center; gap: 10px; transition: 0.2s; border: 1px solid transparent; }
        .room-btn:hover { background: #404249; border-color: var(--text-dim); }
        .room-icon { width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; background: var(--bg-dark); border-radius: 50%; font-size: 12px; }
        
        /* APP */
        #app-screen { display: none; flex: 1; flex-direction: row; background: #313338; overflow: hidden; }
        
        .sidebar { width: 280px; background: var(--bg-panel); display: flex; flex-direction: column; border-right: 1px solid #222; flex-shrink: 0; }
        .sidebar-head { padding: 20px; font-weight: 800; font-size: 18px; border-bottom: 1px solid #1e1f22; display: flex; justify-content: space-between; align-items: center; }
        .admin-badge { background: #fee75c; color: #313338; font-size: 10px; padding: 2px 6px; border-radius: 4px; display: none; }
        .logout-btn { background: transparent; border: 1px solid #da373c; color: #da373c; padding: 4px 8px; font-size: 10px; border-radius: 4px; cursor: pointer; }
        .sidebar-body { padding: 10px; flex: 1; overflow-y: auto; }
        .label { font-size: 12px; font-weight: 700; color: #949BA4; text-transform: uppercase; margin: 16px 10px 8px; display: block; }
        .code-box { background: var(--bg-dark); padding: 12px; border-radius: 6px; margin: 0 10px; cursor: pointer; text-align: center; border: 1px dashed var(--text-dim); }
        .code-text { color: var(--accent); font-weight: 700; font-family: monospace; font-size: 15px; }
        
        .user-item { display: flex; align-items: center; padding: 8px 10px; border-radius: 6px; margin-bottom: 4px; cursor: context-menu; transition: background 0.1s; }
        .user-item:hover { background: rgba(78, 80, 88, 0.4); }
        .avatar-wrapper { position: relative; margin-right: 12px; width: 36px; height: 36px; flex-shrink: 0; }
        .avatar-img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; background: var(--accent); transition: box-shadow 0.1s ease-out; }
        .user-item.speaking .avatar-img { box-shadow: 0 0 0 3px #23a559, 0 0 15px rgba(35, 165, 89, 0.7); border-color: transparent; }
        .user-name { font-weight: 600; font-size: 15px; color: #f2f3f5; }
        
        .controls { background: #232428; padding: 0 12px; height: 60px; display: flex; align-items: center; flex-shrink: 0; }
        .my-info { display: flex; align-items: center; flex: 1; overflow: hidden; margin-right: 10px; cursor: pointer; padding: 6px; border-radius: 6px; }
        .actions-container { display: flex; gap: 6px; }
        .icon-btn { background: transparent; border: none; cursor: pointer; color: var(--text-dim); width: 36px; height: 36px; border-radius: 6px; display: flex; align-items: center; justify-content: center; }
        .icon-btn:hover { background: rgba(78, 80, 88, 0.6); color: #dbdee1; }
        .icon-btn.off { color: var(--red); position: relative; }
        .icon-btn.off svg { fill: var(--red); }
        .icon-btn.off::after { content: ''; position: absolute; width: 24px; height: 2px; background: var(--red); transform: rotate(-45deg); }
        .icon-btn.active { color: var(--green); background: rgba(35, 165, 89, 0.15); }
        .icon-btn.locked { opacity: 0.5; cursor: not-allowed; }
        #voice-join-btn { background: var(--green); color: white; border: none; padding: 8px 16px; border-radius: 4px; font-weight: bold; cursor: pointer; font-size: 13px; }
        
        .chat { flex: 1; display: flex; flex-direction: column; background: #313338; position: relative; overflow: hidden; }
        #video-stage { display: none; padding: 10px; background: #000; border-bottom: 1px solid #222; max-height: 50%; flex-shrink: 0; overflow: hidden; justify-content: center; }
        #video-stage.visible { display: flex; }
        .screen-video { max-width: 100%; max-height: 300px; border-radius: 8px; background: #111; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
        .messages { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 16px; min-height: 0; scroll-behavior: smooth; }
        .msg { display: flex; gap: 12px; margin-top: 6px; align-items: flex-start; }
        .msg:hover { background: rgba(2, 2, 2, 0.03); }
        .msg-avatar { width: 40px; height: 40px; min-width: 40px; border-radius: 50%; object-fit: cover; flex-shrink: 0; }
        .msg-content-wrapper { flex: 1; min-width: 0; }
        .msg-header { display: flex; align-items: center; gap: 6px; margin-bottom: 2px; }
        .msg-name { font-weight: 600; color: white; font-size: 16px; }
        .admin-crown { color: #fee75c; font-size: 14px; }
        .msg-content { color: #dbdee1; font-size: 15px; line-height: 1.4; white-space: pre-wrap; word-wrap: break-word; overflow-wrap: break-word; }
        .chat-gif { max-width: 300px; width: 100%; height: auto; border-radius: 8px; margin-top: 5px; display: block; }
        .input-area { padding: 0 20px 24px; background: #313338; position: relative; flex-shrink: 0; }
        .input-wrapper { background: #383a40; border-radius: 8px; display: flex; align-items: center; padding: 0 16px; gap: 10px; }
        .chat-input { flex: 1; background: transparent; border: none; padding: 14px 0; color: white; outline: none; height: 44px; font-size: 15px; }
        
        .popup { position: absolute; bottom: 80px; right: 20px; width: 320px; height: 350px; background: #2b2d31; border-radius: 8px; display: none; flex-wrap: wrap; overflow-y: auto; padding: 12px; z-index: 100; box-shadow: 0 10px 40px rgba(0,0,0,0.5); }
        .popup::-webkit-scrollbar { width: 8px; background: #2b2d31; } .popup::-webkit-scrollbar-thumb { background: #1a1b1e; border-radius: 4px; }
        .emoji-item { font-size: 28px; cursor: pointer; padding: 6px; transition: 0.1s; border-radius: 4px;}
        .emoji-item:hover { background: #40444b; transform: scale(1.1); }
        .gif-item { width: 45%; height: 90px; margin: 2%; cursor: pointer; border-radius: 4px; object-fit: cover; }
        .gif-item:hover { outline: 2px solid var(--accent); }
        
        .context-menu { position: absolute; display: none; background: #111214; border-radius: 4px; width: 200px; padding: 6px; box-shadow: 0 8px 16px rgba(0,0,0,0.5); z-index: 9999; }
        .ctx-item { padding: 8px 12px; border-radius: 2px; color: #b5bac1; font-size: 14px; cursor: pointer; }
        .ctx-item:hover { background: #5865f2; color: white; }
        .ctx-item.danger { color: #da373c; } .ctx-item.danger:hover { background: #da373c; color: white; }
    </style>
</head>
<body onclick="resumeAudio(); hideCtx()">
    <div id="auth-screen">
        <div class="card">
            <h2 id="auth-title" style="color:white; margin-bottom:20px;">–í—Ö—ñ–¥</h2>
            <input type="file" id="avatar-input" accept="image/*" style="display:none" onchange="processAvatar(this)">
            <div class="avatar-upload" onclick="document.getElementById('avatar-input').click()">
                <img id="avatar-preview" src="" style="display:none;">
                <span id="avatar-text">GIF / –§–æ—Ç–æ</span>
            </div>
            <input type="text" id="login-user" placeholder="–ù—ñ–∫–Ω–µ–π–º">
            <input type="password" id="login-pass" placeholder="–ü–∞—Ä–æ–ª—å">
            <button class="btn" id="auth-action-btn" onclick="handleAuth()">–í—Ö—ñ–¥</button>
            <div class="link" onclick="toggleAuth()" id="switch-btn">–°—Ç–≤–æ—Ä–∏—Ç–∏ –∞–∫–∞—É–Ω—Ç</div>
        </div>
    </div>
    <div id="connect-screen" style="display:none;">
        <div class="card">
            <h2 style="color:white; margin-bottom:10px;">–ö—ñ–º–Ω–∞—Ç–∏</h2>
            <p style="color:#b5bac1; font-size:13px; margin-bottom:20px;">–í–∏–±–µ—Ä—ñ—Ç—å –∫—ñ–º–Ω–∞—Ç—É. –Ø–∫—â–æ –≤–æ–Ω–∞ –≤—ñ–ª—å–Ω–∞, –≤–∏ —Å—Ç–∞–Ω–µ—Ç–µ –∞–¥–º—ñ–Ω–æ–º.</p>
            
            <div class="room-list">
                <div class="room-btn" onclick="autoJoin('global')">
                    <div class="room-icon">üåê</div>
                    <div style="font-weight:600; color:white;">–ó–∞–≥–∞–ª—å–Ω–∞</div>
                </div>
                <div class="room-btn" onclick="autoJoin('games')">
                    <div class="room-icon">üéÆ</div>
                    <div style="font-weight:600; color:white;">–Ü–≥—Ä–∏</div>
                </div>
                <div class="room-btn" onclick="autoJoin('music')">
                    <div class="room-icon">üéµ</div>
                    <div style="font-weight:600; color:white;">–ú—É–∑–∏–∫–∞</div>
                </div>
                <div class="room-btn" onclick="autoJoin('memes')">
                    <div class="room-icon">ü§°</div>
                    <div style="font-weight:600; color:white;">–ú–µ–º–∏</div>
                </div>
            </div>

            <div style="margin-top:15px; border-top:1px solid #444; padding-top:15px;">
                <input type="text" id="custom-room" placeholder="–ê–±–æ –Ω–∞–∑–≤–∞ –ø—Ä–∏–≤–∞—Ç–Ω–æ—ó –∫—ñ–º–Ω–∞—Ç–∏...">
                <button class="btn btn-sec" onclick="joinCustom()">–£–≤—ñ–π—Ç–∏</button>
            </div>
        </div>
    </div>
    <div id="app-screen">
        <div id="context-menu" class="context-menu">
            <div class="ctx-item" onclick="adm('force-mute')">üîí –ë–ª–æ–∫. –ú—ñ–∫—Ä–æ—Ñ–æ–Ω</div>
            <div class="ctx-item" onclick="adm('force-unmute')">üîì –†–æ–∑–±–ª–æ–∫. –ú—ñ–∫—Ä–æ—Ñ–æ–Ω</div>
            <div style="height:1px; background:#333; margin:4px 0"></div>
            <div class="ctx-item danger" onclick="adm('kick')">üö™ –ö—ñ–∫–Ω—É—Ç–∏</div>
            <div class="ctx-item danger" onclick="adm('ban')">üö´ –ë–∞–Ω</div>
        </div>
        <div id="msg-menu" class="context-menu">
            <div class="ctx-item" onclick="copyMsg()">üìã –ö–æ–ø—ñ—é–≤–∞—Ç–∏ —Ç–µ–∫—Å—Ç</div>
        </div>

        <div class="sidebar">
            <div class="sidebar-head">
                WEZZY
                <div style="display:flex; gap:5px; align-items:center;">
                    <div id="admin-indicator" class="admin-badge">ADMIN</div>
                    <button class="logout-btn" onclick="logout()">–í–ò–ô–¢–ò</button>
                </div>
            </div>
            <div class="sidebar-body">
                <span class="label" id="room-name-display">–ö—ñ–º–Ω–∞—Ç–∞</span>
                <div class="code-box" onclick="copyId()"><div class="code-text" id="my-id">...</div></div>
                <span class="label">–£—á–∞—Å–Ω–∏–∫–∏</span>
                <div id="user-list"></div>
            </div>
            <div class="controls">
                <div class="my-info">
                    <div class="avatar-wrapper">
                        <img id="current-user-avatar" class="avatar-img" src="">
                    </div>
                    <div style="font-weight:600; font-size:14px;" id="current-user-name">User</div>
                </div>
                <div class="actions-container">
                    <button id="voice-join-btn" onclick="joinVoice()">Voice</button>
                    <div id="voice-actions" style="display:none; align-items: center; gap: 4px;">
                        <button class="icon-btn" id="btn-mic" onclick="toggleMic()">üé§</button>
                        <button class="icon-btn" id="btn-screen" onclick="toggleScreenShare()">üñ•Ô∏è</button>
                        <button class="icon-btn" id="btn-deaf" onclick="toggleDeaf()">üéß</button>
                        <button class="icon-btn" onclick="leaveVoice()" style="color: #da373c;">‚ùå</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="chat">
            <div id="video-stage"></div>
            <div class="messages" id="msgs">
                <div style="margin-top:auto; padding-bottom:10px;">
                    <h2 style="color:white; margin:0;" id="chat-header"># —á–∞—Ç</h2>
                </div>
            </div>
            <div id="pop-emoji" class="popup"></div>
            <div id="pop-gif" class="popup"></div>
            <div class="input-area">
                <div class="input-wrapper">
                    <button class="icon-btn" onclick="togglePopup('gif')" style="font-size:10px; width:40px;">GIF</button>
                    <input type="text" class="chat-input" id="chat-in" placeholder="–ù–∞–ø–∏—Å–∞—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è..." onkeydown="checkEnter(event)">
                    <button class="icon-btn" onclick="togglePopup('emoji')">üòä</button>
                </div>
            </div>
        </div>
    </div>
    <div id="audio-container"></div>
    <script>
        const DB_KEY = 'wezzy_v7_auto_'; 
        const PREFIX = 'rucord_room_v1_';
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function resumeAudio() { if (audioCtx.state === 'suspended') audioCtx.resume(); }
        function playTone(f) { resumeAudio(); const o=audioCtx.createOscillator(), g=audioCtx.createGain(); o.frequency.value=f; g.gain.value=0.03; o.connect(g); g.connect(audioCtx.destination); o.start(); o.stop(audioCtx.currentTime+0.1); }
        const snd = { click: ()=>playTone(600), msg: ()=>playTone(900), join: ()=>playTone(400) };
        
        let peer, myStream, myScreenStream, myName, myAvatar=null, myGif=null, conns=[], isReg=false, muted=true, deaf=true, isInVoice=false, isAdmin=false, serverMuted=false, selUser=null, usersData={};
        let chatHistory = []; 
        let isSharingScreen = false;
        let connectedPeers = new Set();
        let msgTextToCopy = "";

        window.onload = function() {
            const last = localStorage.getItem(DB_KEY + 'last');
            if(last) {
                const data = JSON.parse(localStorage.getItem(DB_KEY + last));
                if(data) {
                    document.getElementById('login-user').value = last;
                    document.getElementById('login-pass').value = data.pass;
                    if(data.ava) { myAvatar = data.ava; myGif = data.gif; updateAvatarPreview(); }
                }
            }
            buildPopups();
        }

        function processAvatar(input) {
            const file=input.files[0]; if(!file)return;
            if (file.size > 1.5 * 1024 * 1024) return alert("–§–∞–π–ª –∑–∞–Ω–∞–¥—Ç–æ –≤–µ–ª–∏–∫–∏–π! –ú–∞–∫—Å–∏–º—É–º 1.5 –ú–ë.");
            const reader = new FileReader();
            reader.onload = function(e) {
                const result = e.target.result;
                if(file.type === 'image/gif') {
                    myAvatar = result; myGif = result; updateAvatarPreview();
                } else {
                    const img = new Image(); img.src = result;
                    img.onload = function() {
                        const c = document.createElement('canvas'), ctx = c.getContext('2d');
                        c.width = 120; c.height = 120; ctx.drawImage(img, 0, 0, 120, 120);
                        myAvatar = c.toDataURL('image/jpeg', 0.7); myGif = null; updateAvatarPreview();
                    }
                }
            }
            reader.readAsDataURL(file);
        }

        function updateAvatarPreview() { const img = document.getElementById('avatar-preview'), txt = document.getElementById('avatar-text'); if (myAvatar) { img.src = myAvatar; img.style.display = 'block'; txt.style.display = 'none'; } }
        function toggleAuth() { snd.click(); isReg=!isReg; document.getElementById('auth-title').innerText = isReg ? "–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è" : "–í—Ö—ñ–¥"; document.getElementById('switch-btn').innerText = isReg ? "–í–∂–µ —î –∞–∫–∞—É–Ω—Ç" : "–°—Ç–≤–æ—Ä–∏—Ç–∏ –∞–∫–∞—É–Ω—Ç"; document.getElementById('auth-action-btn').innerText = isReg ? "–°—Ç–≤–æ—Ä–∏—Ç–∏" : "–í—Ö—ñ–¥"; }
        function handleAuth() {
            snd.click(); const u = document.getElementById('login-user').value.trim(), p = document.getElementById('login-pass').value.trim();
            if(!u || !p) return alert("–ó–∞–ø–æ–≤–Ω—ñ—Ç—å –ø–æ–ª—è!");
            const key = DB_KEY + u, saved = localStorage.getItem(key), defAva = "https://cdn.discordapp.com/embed/avatars/0.png";
            if(isReg) {
                if(saved) return alert("–ó–∞–π–Ω—è—Ç–æ!");
                localStorage.setItem(key, JSON.stringify({pass:p, ava:myAvatar||defAva, gif:myGif})); localStorage.setItem(DB_KEY+'last', u); myName = u; if(!myAvatar) myAvatar = defAva; enterApp();
            } else {
                if(!saved) return alert("–ê–∫–∞—É–Ω—Ç –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ.");
                const data = JSON.parse(saved); if(data.pass !== p) return alert("–ù–µ–≤—ñ—Ä–Ω–∏–π –ø–∞—Ä–æ–ª—å!");
                myName = u; myAvatar = data.ava; myGif = data.gif; localStorage.setItem(DB_KEY+'last', u); enterApp();
            }
        }
        function enterApp() { document.getElementById('auth-screen').style.display='none'; document.getElementById('connect-screen').style.display='flex'; setupUI(); }
        function logout() { localStorage.removeItem(DB_KEY+'last'); location.reload(); }

        // --- –õ–û–ì–Ü–ö–ê –ê–í–¢–û–ú–ê–¢–ò–ß–ù–û–ì–û –í–•–û–î–£ ---
        function joinCustom() {
            const val = document.getElementById('custom-room').value.trim().toLowerCase();
            if(!val) return alert("–í–≤–µ–¥—ñ—Ç—å –Ω–∞–∑–≤—É –∫—ñ–º–Ω–∞—Ç–∏!");
            autoJoin(val);
        }

        function autoJoin(roomName) {
            snd.click();
            // –ì–µ–Ω–µ—Ä—É—î–º–æ ID –∫—ñ–º–Ω–∞—Ç–∏. –ù–∞–ø—Ä–∏–∫–ª–∞–¥: rucord_room_v1_games
            const roomId = PREFIX + roomName;
            document.getElementById('room-name-display').innerText = "#" + roomName;
            document.getElementById('chat-header').innerText = "# " + roomName;

            navigator.mediaDevices.getUserMedia({audio:true}).then(s=>{
                myStream=s; myStream.getAudioTracks().forEach(t=>t.enabled=false);
                document.getElementById('connect-screen').style.display='none'; 
                document.getElementById('app-screen').style.display='flex';
                
                usersData['me'] = {ava:myAvatar, gif:myGif}; 
                addUserToUI('me', myName, myAvatar);
                
                attemptToHostOrJoin(roomId);

            }).catch(e=>alert("–ú—ñ–∫—Ä–æ—Ñ–æ–Ω –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ: "+e));
        }

        function attemptToHostOrJoin(roomId) {
            // –ö–†–û–ö 1: –ü—Ä–æ–±—É—î–º–æ —Å—Ç–∞—Ç–∏ –•–û–°–¢–û–ú (–∞–¥–º—ñ–Ω–æ–º) —Ü—ñ—î—ó –Ω–∞–∑–≤–∏
            peer = new Peer(roomId, { debug: 2 });
            
            peer.on('open', id => {
                // –Ø–∫—â–æ –≤–¥–∞–ª–æ—Å—è –≤—ñ–¥–∫—Ä–∏—Ç–∏ ID - –∑–Ω–∞—á–∏—Ç—å –º–∏ –ø–µ—Ä—à—ñ, –º–∏ –ê–¥–º—ñ–Ω
                isAdmin = true;
                document.getElementById('admin-indicator').style.display='block';
                document.getElementById('my-id').innerText = "–í–∏ - –ê–¥–º—ñ–Ω –∫—ñ–º–Ω–∞—Ç–∏";
                
                initPeerEvents();
            });

            peer.on('error', err => {
                if(err.type === 'unavailable-id') {
                    // –Ø–∫—â–æ ID –∑–∞–π–Ω—è—Ç–∏–π - –∑–Ω–∞—á–∏—Ç—å –∫—ñ–º–Ω–∞—Ç–∞ –≤–∂–µ —ñ—Å–Ω—É—î. –ü—ñ–¥–∫–ª—é—á–∞—î–º–æ—Å—å –¥–æ –Ω–µ—ó.
                    console.log("–ö—ñ–º–Ω–∞—Ç–∞ —ñ—Å–Ω—É—î. –ü—ñ–¥–∫–ª—é—á–∞—î–º–æ—Å—å...");
                    isAdmin = false;
                    peer.destroy(); // –ó–Ω–∏—â—É—î–º–æ –Ω–µ–≤–¥–∞–ª—É —Å–ø—Ä–æ–±—É
                    
                    // –°—Ç–≤–æ—Ä—é—î–º–æ –≤–∏–ø–∞–¥–∫–æ–≤–∏–π ID –¥–ª—è —Å–µ–±–µ —ñ –∫–æ–Ω–µ–∫—Ç–∏–º–æ—Å—å –¥–æ roomId
                    peer = new Peer({ debug: 2 });
                    peer.on('open', myRandomId => {
                        document.getElementById('my-id').innerText = "–ì—ñ—Å—Ç—å";
                        initPeerEvents();
                        connectTo(roomId); // –ü—ñ–¥–∫–ª—é—á–∞—î–º–æ—Å—å –¥–æ –≥–æ–ª–æ–≤–Ω–æ–≥–æ
                    });
                } else {
                    console.error(err);
                }
            });
        }

        function initPeerEvents() {
            peer.on('call', call => { 
                if (call.metadata && call.metadata.type === 'screen') {
                    call.answer(); 
                    call.on('stream', screenStream => { addVideoToStage(screenStream, call.peer); });
                    call.on('close', () => removeVideoFromStage(call.peer));
                } else {
                    call.answer(myStream); 
                    call.on('stream', s => playAudio(s, call.peer)); 
                    call.on('close', () => removeUser(call.peer)); 
                    connectedPeers.add(call.peer);
                }
            });
            peer.on('connection', c=>{ setupConnection(c); });
            window.onbeforeunload=()=>peer.destroy();
        }

        function connectTo(id) {
            if(id === peer.id || connectedPeers.has(id)) return;
            connectedPeers.add(id);
            const call=peer.call(id, myStream); 
            call.on('stream', s=>playAudio(s,id)); 
            call.on('close', ()=>removeUser(id));
            const c=peer.connect(id); 
            c.on('open', ()=>c.send({t:'join', name:myName, ava:myAvatar, gif:myGif, adm:isAdmin}));
            setupConnection(c);
        }

        function setupConnection(c) {
            conns.push(c); 
            c.on('data', d=>handleData(d,c)); 
            c.on('close', ()=>{ removeUser(c.peer); });
            connectedPeers.add(c.peer);
        }

        function handleData(d, c) {
            if(d.t==='admin-cmd') {
                if(d.cmd==='force-mute') { serverMuted=true; muted=true; if(isInVoice) myStream.getAudioTracks()[0].enabled=false; document.getElementById('btn-mic').classList.add('off','locked'); alert("Muted by Admin."); }
                if(d.cmd==='force-unmute') { serverMuted=false; document.getElementById('btn-mic').classList.remove('locked'); alert("Unmuted by Admin."); }
                if(d.cmd==='kick') { alert("Kicked."); location.reload(); }
            }
            if(d.t==='join') { 
                snd.join(); 
                usersData[c.peer]={ava:d.ava, gif:d.gif}; 
                addUserToUI(c.peer,d.name,d.ava,d.adm); 
                c.send({t:'welcome',name:myName,ava:myAvatar,gif:myGif,adm:isAdmin});
                if(isAdmin) {
                    c.send({t:'history', history: chatHistory});
                    const otherPeers = conns.map(conn => conn.peer).filter(id => id !== c.peer && id !== peer.id);
                    if(otherPeers.length > 0) c.send({t: 'peer-list', peers: otherPeers});
                }
                if(isSharingScreen && myScreenStream) peer.call(c.peer, myScreenStream, {metadata: {type: 'screen'}});
            }
            if(d.t==='peer-list') { d.peers.forEach(id => { connectTo(id); }); }
            if(d.t==='welcome') { usersData[c.peer]={ava:d.ava, gif:d.gif}; addUserToUI(c.peer,d.name,d.ava,d.adm); }
            if(d.t==='chat') { if(isAdmin) chatHistory.push(d); addMsg(d, false, true); }
            if(d.t==='history') { d.history.forEach(msg => { addMsg(msg, msg.name === myName, false); }); }
            if(d.t==='stop-screen') { removeVideoFromStage(c.peer); }
        }

        function toggleScreenShare() {
            if (isSharingScreen) { stopScreenShare(); } else {
                navigator.mediaDevices.getDisplayMedia({ video: true, audio: true }).then(stream => {
                    isSharingScreen = true; myScreenStream = stream; document.getElementById('btn-screen').classList.add('active');
                    addVideoToStage(stream, 'me');
                    conns.forEach(c => { if(c.open) peer.call(c.peer, stream, {metadata: {type: 'screen'}}); });
                    stream.getVideoTracks()[0].onended = stopScreenShare;
                }).catch(e => console.log("Screen share cancelled", e));
            }
        }
        function stopScreenShare() {
            isSharingScreen = false; document.getElementById('btn-screen').classList.remove('active');
            if (myScreenStream) { myScreenStream.getTracks().forEach(track => track.stop()); myScreenStream = null; }
            removeVideoFromStage('me');
            conns.forEach(c => { if(c.open) c.send({t: 'stop-screen'}); });
        }
        function addVideoToStage(stream, id) {
            const stage = document.getElementById('video-stage'); const existing = document.getElementById('vid-'+id); if(existing) existing.remove();
            const v = document.createElement('video'); v.srcObject = stream; v.id = 'vid-' + id; v.className = 'screen-video'; v.autoplay = true; v.muted = (id === 'me'); 
            stage.appendChild(v); stage.classList.add('visible');
        }
        function removeVideoFromStage(id) { const v = document.getElementById('vid-' + id); if(v) v.remove(); const stage = document.getElementById('video-stage'); if(stage.children.length === 0) stage.classList.remove('visible'); }

        function joinVoice() {
            snd.click(); isInVoice=true; muted=false; deaf=false;
            if(serverMuted) { muted=true; document.getElementById('btn-mic').classList.add('off','locked'); }
            else { document.getElementById('btn-mic').classList.remove('off'); if(myStream) myStream.getAudioTracks()[0].enabled=true; }
            document.querySelectorAll('audio').forEach(a=>a.muted=false);
            document.getElementById('voice-join-btn').style.display='none'; document.getElementById('voice-actions').style.display='flex';
            document.getElementById('btn-deaf').classList.remove('off'); resumeAudio(); monitorAudio(myStream, 'me');
        }
        function leaveVoice() {
            snd.click(); isInVoice=false; muted=true; deaf=true; if(myStream) myStream.getAudioTracks()[0].enabled=false;
            document.querySelectorAll('audio').forEach(a=>a.muted=true);
            document.getElementById('voice-actions').style.display='none'; document.getElementById('voice-join-btn').style.display='block';
            const meEl = document.getElementById('u-me'); if(meEl) meEl.classList.remove('speaking'); if(isSharingScreen) stopScreenShare();
        }
        function toggleMic() { if(serverMuted) return; if(deaf) return alert("–£–≤—ñ–º–∫–Ω—ñ—Ç—å –∑–≤—É–∫!"); muted=!muted; myStream.getAudioTracks()[0].enabled=!muted; document.getElementById('btn-mic').classList.toggle('off',muted); }
        function toggleDeaf() { deaf=!deaf; document.querySelectorAll('audio').forEach(a=>a.muted=deaf); document.getElementById('btn-deaf').classList.toggle('off',deaf); if(deaf&&!muted) { muted=true; myStream.getAudioTracks()[0].enabled=false; document.getElementById('btn-mic').classList.add('off'); } }

        function playAudio(s, id) { if(document.getElementById('aud-'+id))return; const a=document.createElement('audio'); a.id='aud-'+id; a.srcObject=s; a.autoplay=true; if(deaf)a.muted=true; document.getElementById('audio-container').appendChild(a); monitorAudio(s,id); }

        function monitorAudio(stream, elementId) {
            const source = audioCtx.createMediaStreamSource(stream), analyser = audioCtx.createAnalyser(); 
            source.connect(analyser); analyser.fftSize = 256; const dataArray = new Uint8Array(analyser.frequencyBinCount);
            let silenceTimer=null, isAnimating=false;
            const checkVolume = () => {
                const el = document.getElementById('u-' + elementId), mySidebarImg = document.getElementById('current-user-avatar'); 
                if (!el && elementId !== 'me') { requestAnimationFrame(checkVolume); return; }
                analyser.getByteFrequencyData(dataArray);
                let sum = 0; for(let i=0;i<dataArray.length;i++) sum+=dataArray[i];
                const isSpeaking = (sum / dataArray.length) > 10; 
                if (elementId === 'me') {
                    if(el) { if(isSpeaking && !muted) el.classList.add('speaking'); else el.classList.remove('speaking'); }
                    if(myAvatar && !myAvatar.startsWith('data:image/gif')) {
                        if(isSpeaking && !muted && myGif) { mySidebarImg.src = myGif; isAnimating = true; if(silenceTimer) clearTimeout(silenceTimer); }
                        else if(isAnimating && !silenceTimer) { silenceTimer = setTimeout(()=>{ mySidebarImg.src = myAvatar; isAnimating=false; silenceTimer=null; }, 400); }
                    }
                } else {
                    const img = el.querySelector('.avatar-img'), uData = usersData[elementId];
                    if (isSpeaking) { el.classList.add('speaking'); if(uData && uData.gif && !uData.ava.startsWith('data:image/gif')) img.src = uData.gif; }
                    else { el.classList.remove('speaking'); if(uData) img.src = uData.ava; }
                }
                requestAnimationFrame(checkVolume);
            }; checkVolume();
        }

        function addUserToUI(id,name,ava,isAdm) { if(document.getElementById('u-'+id))return; const l=document.getElementById('user-list'), d=document.createElement('div'); d.className='user-item'; d.id='u-'+id; if(isAdmin && id!=='me') d.oncontextmenu = e => { e.preventDefault(); showCtx(e,id); }; d.innerHTML=`<div class="avatar-wrapper"><img src="${ava}" class="avatar-img"></div><div class="user-name">${name}${isAdm?' <span style="color:#fee75c">üëë</span>':''}</div>`; l.appendChild(d); }
        function removeUser(id) { 
            const e=document.getElementById('u-'+id); if(e)e.remove(); 
            removeVideoFromStage(id); 
            delete usersData[id];
            connectedPeers.delete(id); 
            conns = conns.filter(c => c.peer !== id);
        }
        
        function checkEnter(e) { if (e.key === 'Enter') sendMsg(); }
        function sendMsg() { const i=document.getElementById('chat-in'), txt=i.value.trim(); if(!txt)return; const d={t:'chat', name:myName, ava:myAvatar, text:txt, adm:isAdmin}; if(isAdmin) chatHistory.push(d); addMsg(d,true, true); conns.forEach(c=> { if(c.open) c.send(d); }); i.value=''; }
        function sendGif(u) { const d={t:'chat', name:myName, ava:myAvatar, text:`<img src="${u}" class="chat-gif">`, adm:isAdmin}; if(isAdmin) chatHistory.push(d); addMsg(d,true, true); conns.forEach(c=> { if(c.open) c.send(d); }); togglePopup('gif'); }
        
        function addMsg(d, isMe, withSound) {
            if(!isMe && withSound) snd.msg();
            const b = document.getElementById('msgs'), div = document.createElement('div'); div.className='msg';
            div.innerHTML = `<img src="${d.ava}" class="msg-avatar"><div class="msg-content-wrapper"><div class="msg-header"><span class="msg-name">${d.name} ${d.adm?'<span class="admin-crown">üëë</span>':''}</span></div><div class="msg-content">${d.text}</div></div>`;
            div.oncontextmenu = function(e) { e.preventDefault(); showMsgCtx(e, d.text); };
            b.appendChild(div);
            const scroll = () => { b.scrollTop = b.scrollHeight; };
            scroll(); requestAnimationFrame(scroll);
            const imgs = div.querySelectorAll('img'); imgs.forEach(i => i.onload = scroll);
        }

        function buildPopups() {
            const ems = [
  'üòÄ','üòÇ','ü•∞','üòé','üò≠','üò°','üëç','üëé','‚ù§Ô∏è','üî•','üíÄ','ü§°','üí©','üëª',
  'üéâ','‚ú®','ü•∫','ü§î','üëÄ','üôå','üíØ','ü§£','üéÇ','üéà','ü•≥','ü§Ø','ü•∂','ü•µ',
  'ü§ë','ü§´','ü§•','üò¨','ü§ê','ü§¢','ü§Æ','ü§ß','üò∑','ü§í','ü§ï','üòà','üëø','üëπ'
];
            const ep = document.getElementById('pop-emoji'); ems.forEach(e=>{ let s=document.createElement('span'); s.className='emoji-item'; s.innerText=e; s.onclick=()=>{document.getElementById('chat-in').value+=e; ep.style.display='none'}; ep.appendChild(s); });
            const gifs = ["https://media.tenor.com/x8v1oNUOmg4AAAAM/rickroll-roll.gif","https://tenor.com/gJfcPaUjgwb.gif","https://tenor.com/bZwvw.gif","https://tenor.com/bVCko.gif","https://tenor.com/WWLP.gif"];
            const gp = document.getElementById('pop-gif'); gifs.forEach(u=>{ let i=document.createElement('img'); i.className='gif-item'; i.src=u; i.onclick=()=>{sendGif(u); gp.style.display='none'}; gp.appendChild(i); });
        }
        function togglePopup(t) { const e = document.getElementById('pop-emoji'), g = document.getElementById('pop-gif'); e.style.display = t==='emoji' && e.style.display==='none' ? 'flex' : 'none'; g.style.display = t==='gif' && g.style.display==='none' ? 'flex' : 'none'; }
        
        function showCtx(e,id) { selUser=id; const m=document.getElementById('context-menu'); m.style.display='block'; m.style.left=e.pageX+'px'; m.style.top=e.pageY+'px'; }
        function showMsgCtx(e, txt) { msgTextToCopy = txt; const m = document.getElementById('msg-menu'); m.style.display='block'; m.style.left = e.pageX + 'px'; m.style.top = e.pageY + 'px'; }
        function copyMsg() { if(msgTextToCopy.includes('<img src=')) { const url = /src="(.*?)"/.exec(msgTextToCopy)[1]; navigator.clipboard.writeText(url); alert("–ü–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ GIF —Å–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ!"); } else { navigator.clipboard.writeText(msgTextToCopy); alert("–¢–µ–∫—Å—Ç —Å–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ!"); } hideCtx(); }
        function hideCtx() { document.getElementById('context-menu').style.display='none'; document.getElementById('msg-menu').style.display='none'; }
        function adm(act) { const c=conns.find(x=>x.peer===selUser); if(c) c.send({t:'admin-cmd', cmd:act}); if(act==='kick') removeUser(selUser); hideCtx(); }
        function setupUI() { document.getElementById('current-user-name').innerText=myName; document.getElementById('current-user-avatar').src=myAvatar; }
        function copyId() { navigator.clipboard.writeText(document.getElementById('my-id').innerText); alert("ID —Å–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ!"); }
    </script>
</body>
</html>
